<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Sua Dieta Personalizada - Dra. Giovana Nutricionista</title>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
       
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       :root {
           --primary: #2c7a2c;
           --secondary: #4a9f4a;
           --accent: #6cc04a;
           --dark: #0a0a0a;
           --light: #ffffff;
           --gray: #1a1a1a;
           --success: #00ff88;
           --danger: #ff3366;
           --gold: #FFD700;
       }

       body {
           font-family: 'Inter', sans-serif;
           background: 
               radial-gradient(circle at 20% 80%, rgba(44, 122, 44, 0.15) 0%, transparent 50%),
               radial-gradient(circle at 80% 20%, rgba(108, 192, 74, 0.15) 0%, transparent 50%),
               radial-gradient(circle at 40% 40%, rgba(74, 159, 74, 0.1) 0%, transparent 50%),
               linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
           min-height: 100vh;
           color: var(--light);
       }

       .particles {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           pointer-events: none;
           z-index: 1;
       }

       .particle {
           position: absolute;
           width: 2px;
           height: 2px;
           background: var(--accent);
           border-radius: 50%;
           animation: float 6s ease-in-out infinite;
           opacity: 0.3;
       }

       .particle:nth-child(odd) {
           background: var(--primary);
           animation-duration: 8s;
       }

       .particle:nth-child(3n) {
           background: var(--secondary);
           animation-duration: 10s;
       }

       @keyframes float {
           0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
           50% { transform: translateY(-100px) rotate(180deg); opacity: 0.8; }
       }

       .header {
           position: relative;
           z-index: 100;
           padding: 20px 0;
           background: rgba(10, 10, 10, 0.9);
           backdrop-filter: blur(20px);
           border-bottom: 1px solid rgba(44, 122, 44, 0.2);
       }

       .header-content {
           max-width: 1200px;
           margin: 0 auto;
           padding: 0 20px;
           display: flex;
           align-items: center;
           justify-content: center;
       }

       .logo {
           display: flex;
           align-items: center;
           gap: 12px;
           font-size: 24px;
           font-weight: 800;
           background: linear-gradient(135deg, var(--primary), var(--accent));
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
           background-clip: text;
       }

       .logo-icon {
           width: 40px;
           height: 40px;
           background: linear-gradient(135deg, var(--primary), var(--secondary));
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 20px;
           box-shadow: 0 4px 20px rgba(44, 122, 44, 0.3);
       }

       .container {
           max-width: 1200px;
           margin: 0 auto;
           padding: 40px 20px;
           position: relative;
           z-index: 10;
       }

       .success-header {
           text-align: center;
           margin-bottom: 50px;
           animation: slideInUp 1s ease-out;
       }

       .success-icon {
           font-size: 100px;
           margin-bottom: 20px;
           animation: successBounce 1.5s ease-out;
       }

       .success-title {
           font-size: 48px;
           font-weight: 900;
           margin-bottom: 15px;
           background: linear-gradient(135deg, var(--success), var(--accent));
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
           background-clip: text;
           line-height: 1.2;
       }

       .success-subtitle {
           font-size: 20px;
           color: rgba(255, 255, 255, 0.8);
           margin-bottom: 30px;
           line-height: 1.5;
           max-width: 800px;
           margin-left: auto;
           margin-right: auto;
       }

       .welcome-card {
           background: rgba(26, 26, 26, 0.9);
           backdrop-filter: blur(30px);
           border-radius: 32px;
           padding: 40px;
           margin-bottom: 40px;
           position: relative;
           overflow: hidden;
           border: 1px solid rgba(44, 122, 44, 0.2);
           box-shadow: 
               0 32px 64px rgba(0, 0, 0, 0.4),
               inset 0 1px 0 rgba(255, 255, 255, 0.1);
           text-align: center;
       }

       .welcome-card::before {
           content: '';
           position: absolute;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: linear-gradient(135deg, var(--primary), var(--accent), var(--secondary));
           border-radius: 32px;
           padding: 2px;
           mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
           mask-composite: xor;
           -webkit-mask-composite: xor;
           opacity: 0.6;
           animation: borderGlow 3s ease-in-out infinite alternate;
       }

       @keyframes borderGlow {
           0% { opacity: 0.3; }
           100% { opacity: 0.8; }
       }

       .user-name {
           font-size: 32px;
           font-weight: 800;
           color: var(--accent);
           margin-bottom: 15px;
       }

       .email-status {
           background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(44, 122, 44, 0.15));
           border: 2px solid rgba(0, 255, 136, 0.4);
           border-radius: 16px;
           padding: 20px;
           margin-top: 20px;
           text-align: center;
           animation: emailGlow 2s ease-in-out infinite alternate;
       }

       .email-status.sending {
           border-color: #FFD700;
           background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 193, 7, 0.15));
       }

       .email-status.success {
           border-color: #00ff88;
           background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(44, 122, 44, 0.15));
       }

       .email-status.error {
           border-color: #ff3366;
           background: linear-gradient(135deg, rgba(255, 51, 102, 0.15), rgba(220, 53, 69, 0.15));
       }

       @keyframes emailGlow {
           0% { opacity: 0.8; }
           100% { opacity: 1; }
       }

       .email-status h4 {
           font-size: 16px;
           font-weight: 700;
           margin-bottom: 10px;
           display: flex;
           align-items: center;
           justify-content: center;
           gap: 8px;
       }

       .email-status.success h4 { color: #00ff88; }
       .email-status.sending h4 { color: #FFD700; }
       .email-status.error h4 { color: #ff3366; }

       .email-status p {
           font-size: 13px;
           color: rgba(255, 255, 255, 0.8);
           line-height: 1.5;
       }

       .loading-spinner {
           display: inline-block;
           width: 20px;
           height: 20px;
           border: 3px solid rgba(255, 255, 255, 0.3);
           border-radius: 50%;
           border-top-color: #FFD700;
           animation: spin 1s ease-in-out infinite;
       }

       @keyframes spin {
           to { transform: rotate(360deg); }
       }

       .content-grid {
           display: grid;
           grid-template-columns: 1fr 400px;
           gap: 40px;
           margin-bottom: 50px;
           align-items: start;
       }

       .main-content {
           display: flex;
           flex-direction: column;
           gap: 30px;
           min-width: 0;
       }

       .diet-card {
           background: rgba(26, 26, 26, 0.9);
           backdrop-filter: blur(30px);
           border-radius: 24px;
           padding: 35px;
           border: 1px solid rgba(44, 122, 44, 0.2);
           box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
           position: relative;
           overflow: hidden;
           width: 100%;
       }

       .diet-card::before {
           content: '';
           position: absolute;
           top: 0;
           left: -100%;
           width: 100%;
           height: 100%;
           background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
           transition: left 0.6s ease;
       }

       .diet-card:hover::before {
           left: 100%;
       }

       .card-title {
           font-size: 24px;
           font-weight: 800;
           margin-bottom: 20px;
           background: linear-gradient(135deg, var(--light), rgba(255, 255, 255, 0.8));
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
           background-clip: text;
       }

       .profile-summary {
           background: linear-gradient(135deg, rgba(44, 122, 44, 0.1), rgba(108, 192, 74, 0.1));
           border: 2px solid rgba(44, 122, 44, 0.3);
           border-radius: 20px;
           padding: 25px;
           margin-bottom: 25px;
       }

       .profile-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
           gap: 15px;
       }

       .profile-item {
           display: flex;
           align-items: center;
           gap: 10px;
           font-size: 14px;
           min-width: 0;
       }

       .profile-icon {
           width: 30px;
           height: 30px;
           background: linear-gradient(135deg, var(--primary), var(--accent));
           border-radius: 8px;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 14px;
           flex-shrink: 0;
       }

       .profile-item > div {
           min-width: 0;
           word-wrap: break-word;
       }

       .macros-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
           gap: 15px;
           margin-bottom: 25px;
       }

       .macro-card {
           background: rgba(255, 255, 255, 0.05);
           border: 2px solid rgba(255, 255, 255, 0.1);
           border-radius: 16px;
           padding: 20px;
           text-align: center;
           transition: all 0.3s ease;
           min-width: 0;
       }

       .macro-card:hover {
           transform: translateY(-5px);
           border-color: var(--primary);
           box-shadow: 0 10px 30px rgba(44, 122, 44, 0.2);
       }

       .macro-card.calories {
           border-color: var(--danger);
           background: rgba(255, 51, 102, 0.1);
       }

       .macro-card.protein {
           border-color: var(--primary);
           background: rgba(44, 122, 44, 0.1);
       }

       .macro-card.carbs {
           border-color: var(--gold);
           background: rgba(255, 215, 0, 0.1);
       }

       .macro-card.fats {
           border-color: var(--accent);
           background: rgba(108, 192, 74, 0.1);
       }

       .macro-icon {
           font-size: 28px;
           margin-bottom: 10px;
       }

       .macro-value {
           font-size: 24px;
           font-weight: 900;
           margin-bottom: 5px;
           word-break: break-word;
       }

       .macro-value.calories { color: var(--danger); }
       .macro-value.protein { color: var(--primary); }
       .macro-value.carbs { color: var(--gold); }
       .macro-value.fats { color: var(--accent); }

       .macro-label {
           font-size: 12px;
           font-weight: 700;
           color: var(--light);
           text-transform: uppercase;
           letter-spacing: 0.5px;
           word-break: break-word;
       }

       .sidebar {
           display: flex;
           flex-direction: column;
           gap: 25px;
           min-width: 0;
       }

       .download-section {
           background: rgba(26, 26, 26, 0.9);
           backdrop-filter: blur(30px);
           border-radius: 24px;
           padding: 30px;
           border: 1px solid rgba(44, 122, 44, 0.2);
           box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
           position: sticky;
           top: 20px;
           width: 100%;
           max-width: 100%;
       }

       .download-title {
           font-size: 20px;
           font-weight: 800;
           margin-bottom: 20px;
           text-align: center;
           color: var(--accent);
       }

       .download-item {
           display: flex;
           align-items: center;
           gap: 15px;
           padding: 15px;
           background: rgba(255, 255, 255, 0.05);
           border: 1px solid rgba(255, 255, 255, 0.1);
           border-radius: 12px;
           margin-bottom: 15px;
           transition: all 0.3s ease;
           cursor: pointer;
           width: 100%;
           min-width: 0;
       }

       .download-item:hover {
           background: rgba(44, 122, 44, 0.1);
           border-color: var(--primary);
           transform: translateY(-2px);
       }

       .download-item.disabled {
           opacity: 0.6;
           cursor: not-allowed;
           background: rgba(255, 255, 255, 0.03);
       }

       .download-item.disabled:hover {
           background: rgba(255, 255, 255, 0.03);
           border-color: rgba(255, 255, 255, 0.1);
           transform: none;
       }

       .download-icon {
           width: 50px;
           height: 50px;
           background: linear-gradient(135deg, var(--primary), var(--accent));
           border-radius: 12px;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 24px;
           flex-shrink: 0;
       }

       .download-item.disabled .download-icon {
           background: rgba(255, 255, 255, 0.2);
       }

       .download-info {
           flex: 1;
           min-width: 0;
       }

       .download-name {
           font-size: 14px;
           font-weight: 700;
           color: var(--light);
           margin-bottom: 3px;
           word-wrap: break-word;
       }

       .download-desc {
           font-size: 11px;
           color: rgba(255, 255, 255, 0.6);
           word-wrap: break-word;
       }

       .download-button {
           background: linear-gradient(135deg, var(--primary), var(--secondary));
           color: white;
           border: none;
           padding: 15px 30px;
           border-radius: 12px;
           font-size: 14px;
           font-weight: 700;
           cursor: pointer;
           transition: all 0.3s ease;
           text-transform: uppercase;
           letter-spacing: 0.5px;
           width: 100%;
           margin-top: 20px;
       }

       .download-button:hover {
           transform: translateY(-2px);
           box-shadow: 0 8px 25px rgba(44, 122, 44, 0.4);
       }

       .members-area-info {
           background: rgba(0, 123, 255, 0.1);
           border: 1px solid rgba(0, 123, 255, 0.3);
           border-radius: 12px;
           padding: 20px;
           margin-top: 20px;
           text-align: center;
       }

       .members-area-info h4 {
           color: #00bfff;
           font-size: 16px;
           font-weight: 700;
           margin-bottom: 10px;
           display: flex;
           align-items: center;
           justify-content: center;
           gap: 8px;
       }

       .members-area-info p {
           font-size: 13px;
           color: rgba(255, 255, 255, 0.8);
           line-height: 1.5;
       }

       @keyframes slideInUp {
           from {
               opacity: 0;
               transform: translateY(30px);
           }
           to {
               opacity: 1;
               transform: translateY(0);
           }
       }

       @keyframes successBounce {
           0% { transform: scale(0); }
           50% { transform: scale(1.2); }
           100% { transform: scale(1); }
       }

       /* Mobile Responsive */
       @media (max-width: 1024px) {
           .content-grid {
               grid-template-columns: 1fr 350px;
               gap: 30px;
           }
       }

       @media (max-width: 768px) {
           .container {
               padding: 20px 15px;
           }

           .success-title {
               font-size: 32px;
           }

           .success-subtitle {
               font-size: 16px;
           }

           .content-grid {
               grid-template-columns: 1fr;
               gap: 30px;
           }

           .main-content {
               order: -1;
           }

           .sidebar {
               order: 1;
           }

           .profile-grid {
               grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
               gap: 10px;
           }

           .macros-grid {
               grid-template-columns: repeat(2, 1fr);
               gap: 12px;
           }

           .download-section {
               position: static;
           }

           .diet-card, .welcome-card, .download-section {
               padding: 25px 20px;
           }

           .logo {
               font-size: 20px;
           }

           .logo-icon {
               width: 35px;
               height: 35px;
               font-size: 18px;
           }
       }

       @media (max-width: 480px) {
           .success-icon {
               font-size: 70px;
           }

           .success-title {
               font-size: 28px;
           }

           .macros-grid {
               grid-template-columns: 1fr;
           }

           .diet-card, .welcome-card, .download-section {
               padding: 20px 15px;
               border-radius: 16px;
           }

           .profile-grid {
               grid-template-columns: 1fr;
           }
       }
   </style>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
   <div class="particles" id="particles"></div>

   <header class="header">
       <div class="header-content">
           <div class="logo">
               <div class="logo-icon">üë©‚Äç‚öïÔ∏è</div>
               <span>Dra. Giovana Nutricionista</span>
           </div>
       </div>
   </header>

   <div class="container">
       <div class="success-header">
           <div class="success-icon">üéâ</div>
           <h1 class="success-title">Parab√©ns! Sua Dieta Est√° Pronta!</h1>
           <p class="success-subtitle">
               Seu plano nutricional personalizado foi criado com base na sua avalia√ß√£o completa. 
               Agora voc√™ tem tudo que precisa para alcan√ßar seus objetivos de forma saud√°vel e sustent√°vel.
           </p>
       </div>

       <div class="welcome-card">
           <h2 class="user-name" id="userName">Ol√°, Maria Silva!</h2>
           <p style="font-size: 16px; color: rgba(255, 255, 255, 0.8); line-height: 1.5;">
               Seu protocolo nutricional personalizado est√° pronto! Baseado em evid√™ncias cient√≠ficas e 
               adaptado especialmente para seu perfil, objetivos e restri√ß√µes alimentares.
           </p>
           
           <!-- ‚úÖ STATUS DO ENVIO POR EMAIL -->
           <div class="email-status sending" id="emailStatus">
               <h4>
                   <span class="loading-spinner"></span>
                   Enviando sua dieta por email...
               </h4>
               <p>Estamos enviando seu plano personalizado para seu email. Aguarde alguns instantes...</p>
           </div>
       </div>

       <div class="content-grid">
           <div class="main-content">
               <div class="diet-card">
                   <h3 class="card-title">üìä Seu Perfil Nutricional</h3>
                   
                   <div class="profile-summary">
                       <div class="profile-grid" id="profileGrid">
                           <div class="profile-item">
                               <div class="profile-icon">üéØ</div>
                               <div>
                                   <strong>Objetivo:</strong><br>
                                   <span id="userGoal">Perder Peso</span>
                               </div>
                           </div>
                           <div class="profile-item">
                               <div class="profile-icon">‚öñÔ∏è</div>
                               <div>
                                   <strong>Peso Atual:</strong><br>
                                   <span id="userWeight">70kg</span>
                               </div>
                           </div>
                           <div class="profile-item">
                               <div class="profile-icon">üìè</div>
                               <div>
                                   <strong>Altura:</strong><br>
                                   <span id="userHeight">170cm</span>
                               </div>
                           </div>
                           <div class="profile-item">
                               <div class="profile-icon">üéÇ</div>
                               <div>
                                   <strong>Idade:</strong><br>
                                   <span id="userAge">26-35 anos</span>
                               </div>
                           </div>
                           <div class="profile-item">
                               <div class="profile-icon">üèÉ</div>
                               <div>
                                   <strong>Atividade:</strong><br>
                                   <span id="userActivity">Moderada</span>
                               </div>
                           </div>
                           <div class="profile-item">
                               <div class="profile-icon">ü•ó</div>
                               <div>
                                   <strong>Dieta:</strong><br>
                                   <span id="userDiet">Sem restri√ß√µes</span>
                               </div>
                           </div>
                       </div>
                   </div>

                   <h4 style="font-size: 18px; font-weight: 700; margin-bottom: 15px; color: var(--accent);">üî¢ Suas Metas Di√°rias</h4>
                   <div class="macros-grid">
                       <div class="macro-card calories">
                           <div class="macro-icon">üî•</div>
                           <div class="macro-value calories" id="targetCalories">1500</div>
                           <div class="macro-label">Calorias</div>
                       </div>
                       <div class="macro-card protein">
                           <div class="macro-icon">ü•©</div>
                           <div class="macro-value protein" id="targetProtein">120g</div>
                           <div class="macro-label">Prote√≠nas</div>
                       </div>
                       <div class="macro-card carbs">
                           <div class="macro-icon">üåæ</div>
                           <div class="macro-value carbs" id="targetCarbs">150g</div>
                           <div class="macro-label">Carboidratos</div>
                       </div>
                       <div class="macro-card fats">
                           <div class="macro-icon">ü•ë</div>
                           <div class="macro-value fats" id="targetFats">50g</div>
                           <div class="macro-label">Gorduras</div>
                       </div>
                   </div>
               </div>
           </div>

           <div class="sidebar">
               <div class="download-section">
                   <h3 class="download-title">üìÅ Seus Materiais</h3>
                   
                   <div class="download-item" onclick="downloadFile('dieta-personalizada')">
                       <div class="download-icon">üìã</div>
                       <div class="download-info">
                           <div class="download-name">Dieta Personalizada</div>
                           <div class="download-desc">Seu plano completo em PDF</div>
                       </div>
                   </div>

                   <div class="download-item disabled">
                       <div class="download-icon">üìÖ</div>
                       <div class="download-info">
                           <div class="download-name">Card√°pio 30 Dias</div>
                           <div class="download-desc">Dispon√≠vel na √°rea de membros</div>
                       </div>
                   </div>

                   <div class="download-item disabled">
                       <div class="download-icon">üë©‚Äçüç≥</div>
                       <div class="download-info">
                           <div class="download-name">200+ Receitas</div>
                           <div class="download-desc">Dispon√≠vel na √°rea de membros</div>
                       </div>
                   </div>

                   <div class="download-item disabled">
                       <div class="download-icon">üìù</div>
                       <div class="download-info">
                           <div class="download-name">Lista de Alimentos</div>
                           <div class="download-desc">Dispon√≠vel na √°rea de membros</div>
                       </div>
                   </div>

                   <button class="download-button" onclick="downloadFile('dieta-personalizada')">
                       üì• BAIXAR DIETA PERSONALIZADA
                   </button>

                   <div class="members-area-info">
                       <h4>üîë √Årea de Membros</h4>
                       <p>Os demais materiais (card√°pio, receitas e lista de alimentos) est√£o dispon√≠veis na sua √°rea de membros exclusiva. O link de acesso foi enviado para o seu e-mail!</p>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <script>
       // ‚úÖ SISTEMA CORRIGIDO PARA LER DADOS DA P√ÅGINA INDEX
       const DataStorage = {
           isLocalStorageAvailable: function() {
               try {
                   const testKey = 'test_' + Date.now();
                   localStorage.setItem(testKey, 'test');
                   localStorage.removeItem(testKey);
                   return true;
               } catch (e) {
                   return false;
               }
           },
           
           getItem: function(key) {
               const fullKey = 'dra_giovana_' + key;
               if (this.isLocalStorageAvailable()) {
                   try {
                       const value = localStorage.getItem(fullKey);
                       if (value) {
                           console.log(`üìÑ Dados recuperados do localStorage: ${key}`);
                           return JSON.parse(value);
                       }
                   } catch (e) {
                       console.warn('Erro ao ler localStorage:', e);
                   }
               }
               return null;
           },

           setItem: function(key, value) {
               const fullKey = 'dra_giovana_' + key;
               if (this.isLocalStorageAvailable()) {
                   try {
                       localStorage.setItem(fullKey, JSON.stringify(value));
                       console.log(`üíæ Dados salvos: ${key}`);
                       return true;
                   } catch (e) {
                       console.warn('Erro ao salvar localStorage:', e);
                       return false;
                   }
               }
               return false;
           }
       };

       // ‚úÖ FUN√á√ÉO CORRIGIDA PARA LER DADOS DA P√ÅGINA INDEX
       function getQuizData() {
           try {
               const quizData = DataStorage.getItem('quiz_data');
               const checkoutData = DataStorage.getItem('checkout_data');
               const userProfile = DataStorage.getItem('user_profile');
               
               console.log('üîç Dados encontrados:');
               console.log('Quiz Data:', quizData);
               console.log('Checkout Data:', checkoutData);
               console.log('User Profile:', userProfile);
               
               if (quizData && quizData.answers && quizData.results) {
                   return {
                       answers: quizData.answers,
                       results: quizData.results,
                       contact: quizData.answers.contact || {},
                       hasData: true,
                       source: 'quiz_data'
                   };
               }
               
               if (checkoutData && checkoutData.answers && checkoutData.results) {
                   return {
                       answers: checkoutData.answers,
                       results: checkoutData.results,
                       contact: checkoutData.answers.contact || {},
                       hasData: true,
                       source: 'checkout_data'
                   };
               }
               
               if (userProfile) {
                   return {
                       answers: {
                           goal: userProfile.goal,
                           contact: {
                               name: userProfile.name,
                               email: userProfile.email
                           }
                       },
                       results: {
                           bmr: userProfile.bmr,
                           targetCalories: userProfile.targetCalories,
                           projectedWeightChange: userProfile.projectedWeightChange
                       },
                       contact: {
                           name: userProfile.name,
                           email: userProfile.email
                       },
                       hasData: true,
                       source: 'user_profile'
                   };
               }
               
               console.log('‚ö†Ô∏è Nenhum dado do quiz encontrado');
               return {
                   answers: {},
                   results: {},
                   contact: {},
                   hasData: false,
                   source: 'none'
               };
               
           } catch (error) {
               console.error('‚ùå Erro ao ler dados do quiz:', error);
               return {
                   answers: {},
                   results: {},
                   contact: {},
                   hasData: false,
                   source: 'error'
               };
           }
       }

       // Dados padr√£o caso n√£o tenha dados do quiz
       const defaultUserData = {
           name: "Cliente",
           email: "cliente@email.com",
           goal: "lose_weight",
           gender: "female",
           age: "26-35",
           activity: "moderate",
           weight: 75,
           height: 165,
           targetWeight: 65,
           diet: "no_restrictions",
           health: ["healthy"],
           allergies: ["no_allergies"],
           dataSource: 'default'
       };

       // ‚úÖ MAPEAMENTO PARA AS 6 NOVAS PERGUNTAS
       function mapOldToNewStructure(answers) {
           if (answers.frustration || answers.urgency || answers.attempts) {
               return answers;
           }
           
           return {
               frustration: answers.frustration || answers.goal || 'no_results',
               urgency: answers.urgency || '1_month',
               attempts: answers.attempts || ['generic_apps'],
               physical: answers.physical || {
                   current_weight: answers.weight,
                   height: answers.height,
                   dream_weight: answers.target_weight || answers.targetWeight,
                   age: answers.age
               },
               lifestyle: answers.lifestyle || answers.diet || ['no_restrictions'],
               contact: answers.contact || {
                   name: answers.name,
                   email: answers.email,
                   whatsapp: answers.phone
               }
           };
       }

       // Tradu√ß√µes completas
       const translations = {
           goal: {
               lose_weight: "Perder Peso",
               gain_muscle: "Ganhar Massa Muscular", 
               maintain: "Manter Peso",
               health: "Melhorar Sa√∫de"
           },
           gender: {
               male: "Masculino",
               female: "Feminino"
           },
           activity: {
               sedentary: "Sedent√°rio",
               light: "Leve",
               moderate: "Moderada",
               intense: "Intensa"
           },
           diet: {
               no_restrictions: "Sem restri√ß√µes",
               vegetarian: "Vegetariana",
               vegan: "Vegana",
               low_carb: "Low Carb",
               mediterranean: "Mediterr√¢nea",
               paleo: "Paleo"
           },
           age: {
               "18-25": "18-25 anos",
               "26-35": "26-35 anos", 
               "36-45": "36-45 anos",
               "46-55": "46-55 anos",
               "55+": "55+ anos"
           },
           health: {
               healthy: "Saud√°vel",
               diabetes: "Diabetes",
               hypertension: "Hipertens√£o",
               thyroid: "Problemas na Tireoide",
               digestive: "Problemas Digestivos",
               kidney: "Problemas Renais",
               heart: "Problemas Card√≠acos"
           },
           allergies: {
               no_allergies: "Sem Alergias",
               lactose: "Intoler√¢ncia √† Lactose",
               gluten: "Intoler√¢ncia ao Gl√∫ten",
               nuts: "Alergia a Oleaginosas",
               seafood: "Alergia a Frutos do Mar",
               eggs: "Alergia a Ovos",
               soy: "Alergia √† Soja"
           }
       };

       // ‚úÖ FUN√á√ÉO MELHORADA PARA PROCESSAR DADOS
       function processUserData(quizData) {
           console.log('üîÑ Processando dados do usu√°rio:', quizData);
           
           if (!quizData.hasData) {
               console.log('üìù Usando dados padr√£o - n√£o h√° dados do quiz');
               return {
                   ...defaultUserData,
                   dataSource: 'default'
               };
           }
           
           const rawAnswers = quizData.answers;
           const answers = mapOldToNewStructure(rawAnswers);
           const { contact, results } = quizData;

           console.log('üîÑ Estrutura mapeada:', answers);
           
           const physical = answers.physical || {};
           
           const processedData = {
               name: contact.name || answers.contact?.name || 'Cliente',
               email: contact.email || answers.contact?.email || '',
               phone: contact.phone || answers.contact?.phone || '',
               
               goal: answers.goal || 'lose_weight',
               gender: answers.gender || 'female',
               age: answers.age || '26-35',
               activity: answers.activity || 'moderate',
               diet: answers.diet || 'no_restrictions',
               
               weight: parseFloat(physical.weight) || 70,
               height: parseFloat(physical.height) || 170,
               targetWeight: parseFloat(physical.target_weight) || 65,
               
               health: Array.isArray(answers.health) ? answers.health : ['healthy'],
               allergies: Array.isArray(answers.allergies) ? answers.allergies : ['no_allergies'],
               
               dataSource: quizData.source,
               hasRealData: true
           };
           
           console.log('‚úÖ Dados processados com sucesso:', processedData);
           
           if (processedData.weight < 30 || processedData.weight > 300) {
               console.warn('‚ö†Ô∏è Peso inv√°lido detectado, usando valor padr√£o');
               processedData.weight = 70;
               processedData.hasRealData = false;
           }
           
           if (processedData.height < 100 || processedData.height > 250) {
               console.warn('‚ö†Ô∏è Altura inv√°lida detectada, usando valor padr√£o');
               processedData.height = 170;
               processedData.hasRealData = false;
           }
           
           return processedData;
       }

       // ‚úÖ FUN√á√ÉO PARA CALCULAR NUTRI√á√ÉO (usando dados corrigidos)
       function calculateNutritionFromQuiz(userData) {
           console.log('üßÆ Calculando nutri√ß√£o para:', userData);
           
           const weight = userData.weight;
           const height = userData.height;
           const goal = userData.goal;
           const activity = userData.activity;
           const gender = userData.gender;
           
           const ageRanges = {
               '18-25': 21.5,
               '26-35': 30.5,
               '36-45': 40.5,
               '46-55': 50.5,
               '55+': 60
           };
           const ageValue = ageRanges[userData.age] || 30;
           
           let bmr;
           if (gender === 'male') {
               bmr = 10 * weight + 6.25 * height - 5 * ageValue + 5;
           } else {
               bmr = 10 * weight + 6.25 * height - 5 * ageValue - 161;
           }
           
           const activityMultipliers = {
               sedentary: 1.2,
               light: 1.375,
               moderate: 1.55,
               intense: 1.725
           };
           
           const tdee = Math.round(bmr * (activityMultipliers[activity] || 1.55));
           
           let calories;
           switch(goal) {
               case 'lose_weight':
                   calories = Math.round(tdee - 500);
                   break;
               case 'gain_muscle':
                   calories = Math.round(tdee + 300);
                   break;
               default:
                   calories = Math.round(tdee);
           }
           
           const protein = Math.round(weight * 2.2);
           const fats = Math.round(calories * 0.3 / 9);
           const carbs = Math.round((calories - (protein * 4) - (fats * 9)) / 4);
           
           const result = { 
               calories, 
               protein, 
               carbs, 
               fats,
               bmr: Math.round(bmr),
               tdee: tdee
           };
           
           console.log('‚úÖ Nutri√ß√£o calculada:', result);
           return result;
       }

       // ‚úÖ ========== SISTEMA DE ENVIO POR EMAIL ========== //

       // ‚úÖ FUN√á√ÉO PARA ENVIAR EMAIL COM WEBHOOK
       async function sendDietEmail(userData, pdfBlob) {
           console.log('üìß Enviando dieta por email para:', userData.email);
           
           try {
               const pdfBase64 = await blobToBase64(pdfBlob);
               
               const emailData = {
                   to: userData.email,
                   name: userData.name,
                   subject: `üéØ Sua Dieta Personalizada Est√° Pronta - ${userData.name}!`,
                   pdfData: pdfBase64,
                   userData: userData,
                   timestamp: new Date().toISOString()
               };
               
               // ‚úÖ WEBHOOK PARA ENVIO (voc√™ deve configurar este endpoint)
               // Exemplo de webhook do Make.com ou Zapier
               const webhookUrl = 'https://hook.us1.make.com/c9fwSaz82nbCe7gsrkZgllelsajk5fnm';
               
               const response = await fetch(webhookUrl, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
                   body: JSON.stringify(emailData)
               });
               
               if (response.ok) {
                   console.log('‚úÖ Email enviado com sucesso');
                   return { success: true };
               } else {
                   console.error('‚ùå Erro no webhook:', response.status);
                   return { success: false, error: 'Erro no servidor' };
               }
               
           } catch (error) {
               console.error('‚ùå Erro ao enviar email:', error);
               return { success: false, error: error.message };
           }
       }

       // ‚úÖ FUN√á√ÉO PARA CONVERTER BLOB EM BASE64
       function blobToBase64(blob) {
           return new Promise((resolve, reject) => {
               const reader = new FileReader();
               reader.onloadend = () => {
                   const base64 = reader.result.split(',')[1];
                   resolve(base64);
               };
               reader.onerror = reject;
               reader.readAsDataURL(blob);
           });
       }

       // ‚úÖ FUN√á√ÉO PARA ATUALIZAR STATUS DO EMAIL
       function updateEmailStatus(status, message) {
           const emailStatus = document.getElementById('emailStatus');
           if (!emailStatus) return;
           
           emailStatus.classList.remove('sending', 'success', 'error');
           emailStatus.classList.add(status);
           
           let icon, title;
           
           switch(status) {
               case 'sending':
                   icon = '<span class="loading-spinner"></span>';
                   title = 'Enviando sua dieta por email...';
                   break;
               case 'success':
                   icon = '‚úÖ';
                   title = 'Dieta enviada com sucesso!';
                   break;
               case 'error':
                   icon = '‚ùå';
                   title = 'Erro ao enviar email';
                   break;
           }
           
           emailStatus.innerHTML = `
               <h4>${icon} ${title}</h4>
               <p>${message}</p>
           `;
       }

       // ‚úÖ FUN√á√ÉO PRINCIPAL PARA PROCESSAR ENVIO
       async function processEmailSending(userData, nutrition) {
           console.log('üìß Iniciando processo de envio por email...');
           
           try {
               updateEmailStatus('sending', 'Estamos preparando sua dieta personalizada e enviando para seu email...');
               
               console.log('üìÑ Gerando PDF...');
               const doc = generateDietaPDF();
               const pdfBlob = doc.output('blob');
               
               await new Promise(resolve => setTimeout(resolve, 2000));
               
               console.log('üìß Enviando email...');
               const emailResult = await sendDietEmail(userData, pdfBlob);
               
               if (emailResult.success) {
                   updateEmailStatus('success', 
                       `Sua dieta personalizada foi enviada para <strong>${userData.email}</strong>! ` +
                       'Verifique sua caixa de entrada (e spam) nos pr√≥ximos minutos.'
                   );
                   
                   DataStorage.setItem('email_sent', {
                       sent: true,
                       email: userData.email,
                       timestamp: new Date().toISOString()
                   });
                   
               } else {
                   updateEmailStatus('error', 
                       'N√£o conseguimos enviar o email automaticamente. ' +
                       'Voc√™ pode baixar sua dieta usando o bot√£o abaixo e tamb√©m entraremos em contato.'
                   );
               }
               
           } catch (error) {
               console.error('‚ùå Erro no processo de email:', error);
               updateEmailStatus('error', 
                   'Erro tempor√°rio no envio. Voc√™ pode baixar sua dieta usando o bot√£o abaixo.'
               );
           }
       }

       // ‚úÖ FUN√á√ÉO PRINCIPAL CORRIGIDA PARA CARREGAR DADOS
       function loadUserData() {
           console.log('üöÄ Carregando dados do usu√°rio - vers√£o com email...');
           
           try {
               const quizData = getQuizData();
               console.log('üìÑ Dados brutos recuperados:', quizData);
               
               const userData = processUserData(quizData);
               console.log('üë§ Dados do usu√°rio processados:', userData);
               
               const nutrition = calculateNutritionFromQuiz(userData);
               console.log('üßÆ Nutri√ß√£o calculada:', nutrition);
               
               const hasRealData = quizData.hasData && userData.hasRealData;
               console.log('üîç Usando dados reais?', hasRealData);
               
               updateUserInterface(userData, nutrition);
               
               window.currentUserData = userData;
               window.currentNutrition = nutrition;
               window.hasRealData = hasRealData;
               window.dataSource = quizData.source;
               
               // ‚úÖ INICIAR ENVIO POR EMAIL AUTOMATICAMENTE
               if (userData.email && userData.email !== 'cliente@email.com') {
                   console.log('üìß Iniciando envio autom√°tico por email...');
                   setTimeout(() => {
                       processEmailSending(userData, nutrition);
                   }, 1000);
               } else {
                   console.log('‚ö†Ô∏è Email n√£o encontrado, pulando envio autom√°tico');
                   updateEmailStatus('error', 'Email n√£o encontrado nos dados do quiz.');
               }
               
               console.log('‚úÖ Sistema carregado com sucesso!');
               
           } catch (error) {
               console.error('‚ùå Erro ao carregar dados:', error);
               
               const userData = { ...defaultUserData, dataSource: 'error_fallback' };
               const nutrition = calculateNutritionFromQuiz(userData);
               
               updateUserInterface(userData, nutrition);
               updateEmailStatus('error', 'Erro ao carregar dados. Baixe manualmente.');
               
               window.currentUserData = userData;
               window.currentNutrition = nutrition;
               window.hasRealData = false;
               
               console.log('üîÑ Fallback aplicado - usando dados padr√£o');
           }
       }

       // Fun√ß√£o para gerar mensagem personalizada baseada no objetivo
       function getPersonalizedMessage(userData) {
           const { goal, weight, targetWeight, health, allergies } = userData;
           
           let message = "";
           
           switch(goal) {
               case 'lose_weight':
                   const weightToLose = weight - targetWeight;
                   message = `Seu protocolo foi desenvolvido para eliminar ${weightToLose}kg de forma saud√°vel e sustent√°vel. `;
                   break;
               case 'gain_muscle':
                   message = "Seu protocolo foi desenvolvido para ganho de massa muscular magra e defini√ß√£o corporal. ";
                   break;
               case 'maintain':
                   message = "Seu protocolo foi desenvolvido para manuten√ß√£o do peso e equil√≠brio nutricional. ";
                   break;
               case 'health':
                   message = "Seu protocolo foi desenvolvido para otimiza√ß√£o da sa√∫de e bem-estar geral. ";
                   break;
           }
           
           if (health && health.length > 0 && !health.includes('healthy')) {
               message += "Consideramos suas condi√ß√µes de sa√∫de espec√≠ficas na elabora√ß√£o do plano. ";
           }
           
           if (allergies && allergies.length > 0 && !allergies.includes('no_allergies')) {
               message += "Todas as suas restri√ß√µes alimentares foram respeitadas no card√°pio. ";
           }
           
           return message;
       }

       // Fun√ß√£o para atualizar a interface
       function updateUserInterface(userData, nutrition) {
           const firstName = userData.name.split(' ')[0];
           document.getElementById('userName').textContent = `Ol√°, ${firstName}!`;
           
           document.getElementById('userGoal').textContent = translations.goal[userData.goal] || 'Objetivo n√£o definido';
           document.getElementById('userWeight').textContent = userData.weight + 'kg';
           document.getElementById('userHeight').textContent = userData.height + 'cm';
           document.getElementById('userAge').textContent = translations.age[userData.age] || userData.age;
           document.getElementById('userActivity').textContent = translations.activity[userData.activity] || 'N√£o definido';
           document.getElementById('userDiet').textContent = translations.diet[userData.diet] || 'N√£o definido';
           
           document.getElementById('targetCalories').textContent = nutrition.calories;
           document.getElementById('targetProtein').textContent = nutrition.protein + 'g';
           document.getElementById('targetCarbs').textContent = nutrition.carbs + 'g';
           document.getElementById('targetFats').textContent = nutrition.fats + 'g';
           
           const welcomeCard = document.querySelector('.welcome-card p');
           if (welcomeCard) {
               const personalizedMessage = getPersonalizedMessage(userData);
               welcomeCard.innerHTML = personalizedMessage + 'Baseado em evid√™ncias cient√≠ficas e adaptado especialmente para seu perfil, objetivos e restri√ß√µes alimentares.';
           }
           
           addHealthInformation(userData);
       }

       // Fun√ß√£o para adicionar informa√ß√µes de sa√∫de
       function addHealthInformation(userData) {
           const profileGrid = document.getElementById('profileGrid');
           
           if (userData.health && userData.health.length > 0 && !userData.health.includes('healthy')) {
               const healthItem = document.createElement('div');
               healthItem.className = 'profile-item';
               healthItem.innerHTML = `
                   <div class="profile-icon">üè•</div>
                   <div>
                       <strong>Condi√ß√µes:</strong><br>
                       <span>${userData.health.map(h => translations.health[h] || h).join(', ')}</span>
                   </div>
               `;
               profileGrid.appendChild(healthItem);
           }
           
           if (userData.allergies && userData.allergies.length > 0 && !userData.allergies.includes('no_allergies')) {
               const allergyItem = document.createElement('div');
               allergyItem.className = 'profile-item';
               allergyItem.innerHTML = `
                   <div class="profile-icon">‚ö†Ô∏è</div>
                   <div>
                       <strong>Restri√ß√µes:</strong><br>
                       <span>${userData.allergies.map(a => translations.allergies[a] || a).join(', ')}</span>
                   </div>
               `;
               profileGrid.appendChild(allergyItem);
           }
       }

       // üí∞ FUN√á√ÉO DE GERA√á√ÉO DE PDF (mantida igual)
       function generateDietaPDF() {
           const { jsPDF } = window.jspdf;
           const doc = new jsPDF();
           
           const userData = window.currentUserData || defaultUserData;
           const nutrition = window.currentNutrition || { calories: 1500, protein: 120, carbs: 150, fats: 50 };
           
           console.log('üîÑ Gerando PDF com dados:', userData);
           
           function addTextWithWrap(text, x, y, maxWidth = 160) {
               const words = text.split(' ');
               let line = '';
               let currentY = y;
               
               for (let i = 0; i < words.length; i++) {
                   const testLine = line + words[i] + ' ';
                   const testWidth = doc.getTextWidth(testLine);
                   
                   if (testWidth > maxWidth && line !== '') {
                       doc.text(line.trim(), x, currentY);
                       line = words[i] + ' ';
                       currentY += 5;
                       
                       if (currentY > 270) {
                           doc.addPage();
                           currentY = 30;
                       }
                   } else {
                       line = testLine;
                   }
               }
               
               if (line.trim() !== '') {
                   doc.text(line.trim(), x, currentY);
                   currentY += 5;
               }
               
               return currentY;
           }
           
           function checkNewPage(currentY, spaceNeeded = 30) {
               if (currentY + spaceNeeded > 280) {
                   doc.addPage();
                   return 30;
               }
               return currentY;
           }
           
           try {
               // =================== CAPA ===================
               doc.setFillColor(44, 122, 44);
               doc.rect(0, 0, 210, 297, 'F');
               
               doc.setTextColor(255, 255, 255);
               doc.setFontSize(32);
               doc.text('DIETA PERSONALIZADA', 105, 70, { align: 'center' });
               
               doc.setFontSize(18);
               doc.text('Protocolo Nutricional Economico', 105, 90, { align: 'center' });
               
               doc.setFontSize(26);
               doc.text(userData.name || 'Cliente', 105, 130, { align: 'center' });
               
               doc.setFontSize(16);
               doc.text(`Objetivo: ${translations.goal[userData.goal] || userData.goal}`, 105, 150, { align: 'center' });
               doc.text(`${nutrition.calories} calorias diarias`, 105, 170, { align: 'center' });
               
               doc.setFontSize(14);
               doc.text('Dra. Giovana Nutricionista', 105, 210, { align: 'center' });
               doc.text('CRN: 3 87654 - Especialista em Nutricao Clinica', 105, 225, { align: 'center' });
               
               const today = new Date().toLocaleDateString('pt-BR');
               doc.text('Data: ' + today, 105, 260, { align: 'center' });
               
               // =================== P√ÅGINA 2 - AVALIA√á√ÉO ===================
               doc.addPage();
               doc.setTextColor(0, 0, 0);
               doc.setFontSize(22);
               doc.setTextColor(44, 122, 44);
               doc.text('SUA AVALIACAO NUTRICIONAL', 20, 25);
               
               doc.setDrawColor(44, 122, 44);
               doc.setLineWidth(2);
               doc.line(20, 30, 190, 30);
               
               let yPos = 45;
               
               doc.setFontSize(14);
               doc.setTextColor(0, 0, 0);
               doc.text('DADOS PESSOAIS', 20, yPos);
               yPos += 15;
               
               doc.setFontSize(11);
               const dadosUsuario = [
                   ['Nome:', userData.name || 'N/A'],
                   ['Email:', userData.email || 'N/A'],
                   ['Objetivo:', translations.goal[userData.goal] || userData.goal],
                   ['Peso Atual:', (userData.weight || 70) + 'kg'],
                   ['Altura:', (userData.height || 170) + 'cm'],
                   ['Faixa Etaria:', translations.age[userData.age] || userData.age],
                   ['Nivel de Atividade:', translations.activity[userData.activity] || userData.activity],
                   ['Tipo de Dieta:', translations.diet[userData.diet] || userData.diet]
               ];
               
               dadosUsuario.forEach(([label, value]) => {
                   yPos = checkNewPage(yPos);
                   doc.text(label, 25, yPos);
                   doc.text(String(value), 80, yPos);
                   yPos += 8;
               });
               
               yPos = checkNewPage(yPos, 60);
               yPos += 15;
               doc.setFontSize(14);
               doc.setTextColor(44, 122, 44);
               doc.text('SEUS NUMEROS', 20, yPos);
               yPos += 12;
               
               doc.setFontSize(11);
               doc.setTextColor(0, 0, 0);
               
               const peso = userData.weight || 70;
               const altura = userData.height || 170;
               const imc = (peso / ((altura/100) * (altura/100))).toFixed(1);
               
               const calculos = [
                   ['IMC:', `${imc} kg/m2`],
                   ['TMB:', `${nutrition.bmr || 'N/A'} cal/dia`],
                   ['Meta Calorias:', `${nutrition.calories} cal`],
                   ['Proteinas:', `${nutrition.protein}g`],
                   ['Carboidratos:', `${nutrition.carbs}g`],
                   ['Gorduras:', `${nutrition.fats}g`]
               ];
               
               calculos.forEach(([label, value]) => {
                   yPos = checkNewPage(yPos);
                   doc.text(label, 25, yPos);
                   doc.text(value, 100, yPos);
                   yPos += 8;
               });
               
               // =================== CARD√ÅPIO E OUTRAS P√ÅGINAS ===================
               doc.addPage();
               doc.setFontSize(20);
               doc.setTextColor(44, 122, 44);
               doc.text('CARDAPIO ECONOMICO - 7 DIAS', 20, 25);
               
               doc.setDrawColor(44, 122, 44);
               doc.setLineWidth(2);
               doc.line(20, 30, 190, 30);
               
               yPos = 45;
               doc.setFontSize(10);
               doc.setTextColor(0, 100, 0);
               doc.text('Cardapio com ingredientes acessiveis (R$ 15-25/dia)', 20, yPos);
               yPos += 15;
               
               doc.setFontSize(10);
               doc.setTextColor(0, 0, 0);
               
               const cardapio = [
                   {
                       dia: 'SEGUNDA-FEIRA',
                       refeicoes: [
                           'Cafe: Ovos mexidos + Pao integral + Cafe',
                           'Lanche: Banana + Amendoim',
                           'Almoco: Frango + Arroz + Feijao + Salada',
                           'Lanche: Vitamina de banana',
                           'Jantar: Ovo + Abobrinha + Batata doce'
                       ]
                   },
                   {
                       dia: 'TERCA-FEIRA',
                       refeicoes: [
                           'Cafe: Aveia com banana + Cafe',
                           'Lanche: Maca + Pasta de amendoim',
                           'Almoco: Carne moida + Arroz + Cenoura',
                           'Lanche: Batata doce cozida',
                           'Jantar: Frango + Abobrinha + Mandioca'
                       ]
                   },
                   {
                       dia: 'QUARTA-FEIRA',
                       refeicoes: [
                           'Cafe: Mingau de aveia + Banana',
                           'Lanche: Laranja + Castanha',
                           'Almoco: Sardinha + Arroz + Feijao + Couve',
                           'Lanche: Abacate com cacau',
                           'Jantar: Ovos + Legumes + Inhame'
                       ]
                   },
                   {
                       dia: 'QUINTA-FEIRA',
                       refeicoes: [
                           'Cafe: Pao integral + Pasta amendoim',
                           'Lanche: Mamao + Aveia',
                           'Almoco: Frango + Macarrao + Molho tomate',
                           'Lanche: Iogurte natural',
                           'Jantar: Carne moida + Abobrinha + Arroz'
                       ]
                   },
                   {
                       dia: 'SEXTA-FEIRA',
                       refeicoes: [
                           'Cafe: Vitamina banana + aveia',
                           'Lanche: Maca + Canela',
                           'Almoco: Frango + Lentilha + Salada',
                           'Lanche: Amendoim torrado',
                           'Jantar: Omelete + Batata doce + Salada'
                       ]
                   },
                   {
                       dia: 'SABADO',
                       refeicoes: [
                           'Cafe: Panqueca aveia + Banana',
                           'Lanche: Banana + Aveia',
                           'Almoco: Sardinha + Arroz + Feijao',
                           'Lanche: Vitamina de manga',
                           'Jantar: Frango + Pure mandioca + Couve'
                       ]
                   },
                   {
                       dia: 'DOMINGO',
                       refeicoes: [
                           'Cafe: Ovos + Abacate + Pao',
                           'Lanche: Banana + Pasta amendoim',
                           'Almoco: Carne + Batata doce + Vagem',
                           'Lanche: Vitamina de frutas',
                           'Jantar: Omelete + Legumes + Mandioca'
                       ]
                   }
               ];
               
               cardapio.forEach(dia => {
                   yPos = checkNewPage(yPos, 35);
                   
                   doc.setFontSize(12);
                   doc.setTextColor(44, 122, 44);
                   doc.text(dia.dia, 20, yPos);
                   yPos += 10;
                   
                   doc.setFontSize(9);
                   doc.setTextColor(0, 0, 0);
                   
                   dia.refeicoes.forEach(refeicao => {
                       yPos = checkNewPage(yPos);
                       yPos = addTextWithWrap(refeicao, 25, yPos, 150);
                       yPos += 2;
                   });
                   yPos += 8;
               });
               
               // =================== P√ÅGINA 4 - RECEITAS ===================
               doc.addPage();
               doc.setFontSize(20);
               doc.setTextColor(44, 122, 44);
               doc.text('RECEITAS ECONOMICAS', 20, 25);
               
               doc.setDrawColor(44, 122, 44);
               doc.setLineWidth(2);
               doc.line(20, 30, 190, 30);
               
               yPos = 45;
               
               const receitas = [
                   {
                       nome: 'Omelete Economica',
                       info: 'Tempo: 10 min | Calorias: 220 | Custo: R$ 2,50',
                       ingredientes: [
                           '2 ovos inteiros',
                           '1 tomate picado',
                           '1 col. cha azeite',
                           'Sal e pimenta a gosto'
                       ],
                       preparo: [
                           'Bata os ovos com sal e pimenta',
                           'Aque√ßa o azeite na frigideira',
                           'Refogue o tomate por 1 minuto',
                           'Adicione os ovos batidos',
                           'Cozinhe em fogo medio por 3-4 min'
                       ]
                   },
                   {
                       nome: 'Frango Temperado Economico',
                       info: 'Tempo: 30 min | Calorias: 280 | Custo: R$ 4,00',
                       ingredientes: [
                           '150g coxa de frango sem pele',
                           '2 dentes alho amassados',
                           '1 col. sopa azeite',
                           'Suco de 1/2 limao',
                           'Sal, pimenta, oregano'
                       ],
                       preparo: [
                           'Tempere o frango com todos os temperos',
                           'Deixe marinar por 15 minutos',
                           'Aque√ßa frigideira com azeite',
                           'Grelhe o frango 8-10 min cada lado'
                       ]
                   }
               ];
               
               receitas.forEach(receita => {
                   yPos = checkNewPage(yPos, 50);
                   
                   doc.setFontSize(14);
                   doc.setTextColor(44, 122, 44);
                   doc.text(receita.nome, 20, yPos);
                   yPos += 8;
                   
                   doc.setFontSize(9);
                   doc.setTextColor(0, 100, 0);
                   doc.text(receita.info, 20, yPos);
                   yPos += 12;
                   
                   doc.setFontSize(11);
                   doc.setTextColor(0, 0, 0);
                   doc.text('INGREDIENTES:', 20, yPos);
                   yPos += 7;
                   
                   doc.setFontSize(9);
                   receita.ingredientes.forEach(ingrediente => {
                       yPos = checkNewPage(yPos);
                       doc.text('- ' + ingrediente, 25, yPos);
                       yPos += 5;
                   });
                   yPos += 5;
                   
                   doc.setFontSize(11);
                   doc.text('MODO DE PREPARO:', 20, yPos);
                   yPos += 7;
                   
                   doc.setFontSize(9);
                   receita.preparo.forEach((passo, index) => {
                       yPos = checkNewPage(yPos);
                       yPos = addTextWithWrap(`${index + 1}. ${passo}`, 25, yPos, 150);
                       yPos += 2;
                   });
                   yPos += 15;
               });
               
               // =================== P√ÅGINA 5 - LISTA DE COMPRAS ===================
               doc.addPage();
               doc.setFontSize(20);
               doc.setTextColor(44, 122, 44);
               doc.text('LISTA DE COMPRAS ECONOMICA', 20, 25);
               
               doc.setDrawColor(44, 122, 44);
               doc.setLineWidth(2);
               doc.line(20, 30, 190, 30);
               
               yPos = 45;
               doc.setFontSize(10);
               doc.setTextColor(0, 100, 0);
               doc.text('Lista organizada por preco - compre no atacado para economizar!', 20, yPos);
               yPos += 15;
               
               const listaCompras = [
                   {
                       categoria: 'PROTEINAS BARATAS (R$ 8-18/kg)',
                       items: [
                           'Ovos (cartela 30 unidades) - R$ 12-15',
                           'Frango coxa/sobrecoxa - R$ 8-12/kg',
                           'Carne moida de segunda - R$ 15-18/kg',
                           'Sardinha em conserva - R$ 3-4/lata',
                           'Feijao carioca - R$ 6-8/kg',
                           'Lentilha - R$ 8-10/kg'
                       ]
                   },
                   {
                       categoria: 'CARBOIDRATOS BARATOS (R$ 2-8/kg)',
                       items: [
                           'Arroz integral - R$ 4-6/kg',
                           'Aveia em flocos - R$ 6-8/kg',
                           'Batata doce - R$ 3-5/kg',
                           'Pao integral - R$ 6-8/unidade',
                           'Banana - R$ 3-5/kg',
                           'Mandioca/Aipim - R$ 2-4/kg'
                       ]
                   },
                   {
                       categoria: 'VEGETAIS BARATOS (R$ 1-5/kg)',
                       items: [
                           'Abobrinha - R$ 2-4/kg',
                           'Repolho - R$ 1-3/kg',
                           'Cenoura - R$ 2-4/kg',
                           'Cebola - R$ 2-4/kg',
                           'Tomate - R$ 3-5/kg',
                           'Couve - R$ 1-2/maco'
                       ]
                   }
               ];
               
               listaCompras.forEach(categoria => {
                   yPos = checkNewPage(yPos, 30);
                   
                   doc.setFontSize(12);
                   doc.setTextColor(44, 122, 44);
                   doc.text(categoria.categoria, 20, yPos);
                   yPos += 10;
                   
                   doc.setFontSize(9);
                   doc.setTextColor(0, 0, 0);
                   
                   categoria.items.forEach(item => {
                       yPos = checkNewPage(yPos);
                       doc.text('- ' + item, 25, yPos);
                       yPos += 6;
                   });
                   yPos += 10;
               });
               
               console.log('‚úÖ PDF gerado com sucesso!');
               return doc;
               
           } catch (error) {
               console.error('‚ùå Erro ao gerar PDF:', error);
               throw error;
           }
       }

       // Fun√ß√£o de download
       function downloadFile(type) {
           if (type !== 'dieta-personalizada') {
               alert('Este material est√° dispon√≠vel na sua √°rea de membros exclusiva! Verifique seu e-mail para o link de acesso.');
               return;
           }

           try {
               const doc = generateDietaPDF();
               const userData = window.currentUserData || { name: 'Cliente' };
               const filename = `Dieta_Economica_${userData.name.replace(/\s+/g, '_')}_DrGiovana.pdf`;
               doc.save(filename);
               
               console.log('üì• Download iniciado:', filename);
               
           } catch (error) {
               console.error('Erro ao gerar PDF:', error);
               alert('Erro ao gerar PDF. Tente novamente.');
           }
       }

       // Inicializa√ß√£o
       document.addEventListener('DOMContentLoaded', function() {
           console.log('üéØ P√°gina de obrigado carregada - vers√£o com email autom√°tico...');
           
           createParticles();
           loadUserData();
           
           console.log('üöÄ Sistema com email autom√°tico inicializado!');
       });

       function createParticles() {
           const particlesContainer = document.getElementById('particles');
           const particleCount = window.innerWidth > 768 ? 50 : 25;

           for (let i = 0; i < particleCount; i++) {
               const particle = document.createElement('div');
               particle.className = 'particle';
               particle.style.left = Math.random() * 100 + '%';
               particle.style.top = Math.random() * 100 + '%';
               particle.style.animationDelay = Math.random() * 6 + 's';
               particlesContainer.appendChild(particle);
           }
       }

       // Salvar progresso
       function saveUserProgress() {
           try {
               if (typeof(Storage) !== "undefined") {
                   sessionStorage.setItem('userCompleted', 'true');
                   sessionStorage.setItem('completionDate', new Date().toISOString());
                   
                   const progressData = {
                       completed: true,
                       completionDate: new Date().toISOString(),
                       pageVisited: 'thank_you_with_email',
                       version: 'economica_com_email_automatico',
                       timestamp: Date.now()
                   };
                   
                   DataStorage.setItem('progress', progressData);
                   console.log('üíæ Progresso salvo - vers√£o com email autom√°tico');
               }
           } catch (error) {
               console.log('‚ö†Ô∏è Erro ao salvar progresso:', error);
           }
       }

       // Executar ao carregar
       saveUserProgress();

       // ‚úÖ TORNAR FUN√á√ïES DISPON√çVEIS GLOBALMENTE PARA DEBUG
       window.getQuizData = getQuizData;
       window.processEmailSending = processEmailSending;
       window.sendDietEmail = sendDietEmail;
       
       console.log('‚úÖ Sistema com email autom√°tico carregado!');
       console.log('üìß Funcionalidades:');
       console.log('  ‚Ä¢ Envio autom√°tico por email ap√≥s compra');
       console.log('  ‚Ä¢ Op√ß√£o manual de download mantida');
       console.log('  ‚Ä¢ Status visual do envio');
       console.log('  ‚Ä¢ Integra√ß√£o com webhooks (Make/Zapier)');
       console.log('üí∞ Para configurar: substitua o webhookUrl pelo seu endpoint');
   </script>
</body>
</html>